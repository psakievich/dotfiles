# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

Personal dotfiles repo using **Spack** as a package manager to vendor binaries and **GNU Stow** to manage symlinks into `$HOME`. The repo is designed as a bare git repository with worktrees, allowing new dotfile configurations to be tested in subshells before migrating to the daily driver.

## Key Commands

### Bootstrap a fresh clone or worktree
```bash
./install.sh        # clone deps via make, source spack, run make all
source .dotprofile   # load shell config (PATH, spack, etc.)
stow .               # create symlinks into $HOME
```

`install.sh` can be run from any directory — it resolves its own location and uses `make -C` to target the repo root.

### Build with Make (preferred)
The `Makefile` includes `internal.mk` which defines all build rules. Environment dependency ordering is declared in the `Makefile` itself.

```bash
make all             # install all spack environments
make core            # install just the core environment
make editor          # install the editor environment
make stow            # run stow via spack's build-env
make <env>-clean     # remove spack.lock for an environment
make <env>-wipe      # remove an environment entirely
make wipe            # remove all environments
```

### Test the local install
After building environments the user profile can be tested without symlinking to `HOME`. This is often the preferred method of working with the repository on corporate systems or group settings where differences in dotfiles can create very challenging bugs to reproduce between developer environments.
```bash
bash -rcfile .dotprofile
```

### Remove symlinks temporarily
```bash
stow -D .
```

### CI
GitHub Actions (`.github/workflows/tests.yml`) runs `install.sh` + `stow .` on `ubuntu-latest` and `macos-14` for pushes/PRs to `main`.

## Architecture

### Build System (`internal.mk`)
The Make-based build system manages Spack environments through a dependency chain:
1. **spack-manager config** → registered as a Spack extension, adds dot-manager
2. **spack.yaml** → copied from `spack_environments/<env>/` into Spack's env directory via `spack manager create-env`
3. **spack.lock** → generated by `spack concretize`
4. **last_build** → sentinel file created after `spack install` and view creation

Each environment gets a view at `spack-views/<env>-bin/` which is added to PATH via `.variables`.

### Machine-Specific Configuration
`Makefile` is the user-facing entry point where you declare environments and their dependency order. `example.mk` shows how to add a machine-specific environment as a prerequisite. The `dot-manager/` directory holds per-platform Spack configs (base, darwin) that get merged via the spack-manager extension.

### Stow Symlink Strategy
`.stow-local-ignore` excludes build infrastructure (spack, Makefile, install scripts, spack_environments, etc.) so that only actual dotfiles get symlinked. The files that get stowed include: `.dotprofile`, `.functions`, `.alias`, `.variables`, `.config/` (nvim, tmux), and similar.

### Shell Configuration
- `.dotprofile` — entry point, sources `.variables`, `.functions`, `.alias`
- `.variables` — PATH setup (spack-views), XDG dirs, EDITOR, PS1
- `.functions` — utility functions (path management, spack helpers, directory navigation)
- `.alias` — shell aliases

### Spack Environments (`spack_environments/`)
- **core**: tmux, stow, python
- **editor**: neovim, ripgrep, py-python-lsp-ruff
- **graphviz**: graphviz, py-graphviz, py-pyyaml

### Neovim Config (`.config/nvim/init.lua`)
Single-file config using mini.nvim (mini.deps) as the plugin manager. Supports multiple modes (develop, pair, blank) toggled via keymaps. LSP servers: pylsp, clangd, lua_ls, marksman.

### Make-Managed Dependencies (`deps.mk`)
Dependencies are cloned via `make deps` instead of git submodules (submodules don't work well with the bare-repo worktree workflow). Version pins and URLs are defined in `deps.mk` and can be overridden for corporate mirrors.
- `spack` — the Spack package manager (shallow clone, pinned to `develop`)
- `spack-manager` — Spack extension for dotfile environment management
- `.tmux/plugins/tpm` — tmux plugin manager
